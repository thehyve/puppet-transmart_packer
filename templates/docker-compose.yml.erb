version: "3"
services:
    redis:
        image: redis:alpine
        command: ["redis-server", "--appendonly", "yes"]
        hostname: redis
        volumes:
            - redis-data:/data
        restart: always
    webapp:
        image: 'thehyve/transmart-packer:<%= @docker_image_version %>'
        command: ['python', '-m', 'packer']
        ports:
            - 8999:8999
        depends_on:
            - redis
        links:
            - redis
        environment:
          TRANSMART_URL: '<%= @transmart_url %>'
          KEYCLOAK_URL: '<%= @keycloak_url %>'
          CLIENT_ORIGIN_URL: '<%= @client_origin_url %>'
        restart: always
    worker:
        image: 'thehyve/transmart-packer:<%= @docker_image_version %>'
        command:  ['celery', '-A', 'packer.tasks', 'worker', '-c', '4', '--loglevel', 'info']
        depends_on:
            - redis
        links:
            - redis
        environment:
          TRANSMART_URL: '<%= @transmart_url %>'
          KEYCLOAK_URL: '<%= @keycloak_url %>'
          CLIENT_ORIGIN_URL: '<%= @client_origin_url %>'
        restart: always

volumes:
  redis-data:
